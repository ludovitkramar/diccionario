<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/scripts/username.mjs" defer type="module"></script>
    <script src="/scripts/functions.js" defer></script>
    <link rel="stylesheet" href="styles/main.css">
    <title>Diccionario</title>
</head>

<body>
    <div id="page">
        <div id="header">
            <div id="logo">Diccionario</div>
            <ul>
                <li><a href="/add">Añadir palabra</a></li>
                <li><a href="#" id="editLink">Editar esta palabra</a></li>
                <li> <a href="/login" id="login">Login</a></li>
            </ul>
        </div>
        <div id="body">
            <div id="searchContainer">
                <form action="" id="searchForm">
                    <input type="text" name="entrada" id="searchBox" required placeholder="Escriba aquí para buscar"
                        autofocus>
                    <input type="submit" value="Buscar" id="searchBut">
                </form>
            </div>
            <div id="entry">
                <article>
                    <dl id="definitions">

                    </dl>
                </article>
            </div>
        </div>
    </div>

    <script type="module">
        import PocketBase from '/scripts/pocketbase.es.mjs'
        var $ = function (id) { return document.getElementById(id) }
        const client = new PocketBase('https://dic.kykvit.com');

        const search = decodeURIComponent(window.location.search.split('=')[1].toLowerCase()) //user's search term

        const records = await client.records.getFullList('words', 1 /* batch size */, {
            filter: `palabra = "${search}"`,
        });

        // if (records[0].id) console.log(records[0].id);
        const id = records[0].id //id of our search term

        const data = await client.records.getOne('words', id, { //query result
            expand: 'definiciones,locuciones.definiciones',
        });

        console.log(data);

        //put the response in html form

        const box = $('definitions') //container
        box.innerHTML = '';

        //palabra
        const wrd = document.createElement('dt')
        wrd.id = 'word'
        wrd.innerText = search
        box.appendChild(wrd)

        //enlace para editar
        $('editLink').href = `/edit?entrada=${search}`

        //etimologia
        const eti = document.createElement('dd')
        eti.classList.add('etimologia')
        eti.appendChild(gen_span_with_i(data.etimologia, '', true))
        box.appendChild(eti)

        var dfnArr = data['@expand'].definiciones; //array of the definitions' object
        dfnArr.sort((a, b) => {
            return a.indice - b.indice;
        })

        //generate definitions elements
        genDefs(dfnArr);

        //get and sort locuciones elements
        var lccArr = data['@expand'].locuciones;
        lccArr.sort((a, b) => {
            if (a.locucion < b.locucion) {
                return -1;
            }
            if (a.locucion > b.locucion) {
                return 1;
            }
            return 0;
        })

        //put locuciones on the screen
        lccArr.forEach(lcc => {
            const loc = document.createElement('dt')
            loc.classList.add('loc')
            loc.appendChild(gen_span_with_i(lcc.locucion, search, false))

            box.appendChild(loc)
            const lc_dfn_arr = lcc['@expand'].definiciones
            lc_dfn_arr.sort((a, b) => {
                return a.indice - b.indice;
            })
            genDefs(lc_dfn_arr, 'lc')
        })

        function genDefs(arr, type) {
            arr.forEach(element => {
                //bloque
                const def = document.createElement('dd');
                def.classList.add('def');
                //indice
                const ind = document.createElement('strong');
                ind.innerText = element.indice + '. ';
                //genero (m. f.)
                const gnr = document.createElement('span')
                gnr.innerText = element.genero + ' ';
                if (element.genero === 'm.') gnr.title = 'nombre masculino'
                if (element.genero === 'f.') gnr.title = 'nombre femenino'
                gnr.classList.add('prop')
                // y mas (Coloq. Rel. ... )
                const prp = document.createElement('span')
                prp.innerText = element.notas + ' '; // TODO: detect and display title with explanations
                prp.classList.add('prop')
                //definicion 
                // TODO: put within <dfn> when encountering the same word as the query (search constant)
                const txt = gen_span_with_i(element.definicion, search, false)
                // const txt = document.createElement('span')
                // txt.innerText = element.definicion;
                //ejemplo
                const ej = document.createElement('dd')
                ej.classList.add('ej');
                ej.innerText = element.ejemplo
                //ej.appendChild(gen_span_with_i(element.ejemplo, search, false))
                //final
                def.appendChild(ind)
                if (type !== 'lc') def.appendChild(gnr)
                def.appendChild(prp)
                def.appendChild(txt)
                box.appendChild(def)
                if (element.ejemplo !== "") { //if there is an example
                    box.appendChild(ej)
                }
            });
        }
    </script>

</body>

</html>